<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tick Analytics Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .glass-sidebar { background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(10px); }
        .custom-checkbox:checked { background-color: #3b82f6; border-color: #3b82f6; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        /* 表格样式优化 */
        .trade-table th { text-align: left; padding: 10px; font-size: 12px; font-weight: bold; color: #94a3b8; border-bottom: 1px solid #334155; }
        .trade-table td { padding: 10px; font-size: 13px; border-bottom: 1px solid rgba(148, 163, 184, 0.05); }
        .trade-table tr:last-child td { border-bottom: none; }
    </style>
</head>
<body class="bg-slate-950 text-slate-300 font-sans h-screen flex flex-col overflow-hidden selection:bg-blue-500 selection:text-white transition-colors duration-300">

    <header id="main-header" class="bg-slate-900 border-b border-slate-800 h-12 flex items-center px-4 justify-between flex-shrink-0 z-20 shadow-md transition-colors duration-300">
        <div class="flex items-center gap-6 text-xs font-mono">
            <div class="flex items-center gap-2">
                <i class="fa-solid fa-layer-group text-blue-500"></i>
                <span id="app-title" class="font-bold text-slate-100 tracking-wider">TICK.USD</span>
            </div>
            <div id="ticker-info" class="flex gap-4 opacity-80 hidden md:flex">
                <span class="info-label text-slate-400">O: <span id="tick-open" class="text-blue-400">--</span></span>
                <span class="info-label text-slate-400">H: <span id="tick-high" class="text-blue-400">--</span></span>
                <span class="info-label text-slate-400">L: <span id="tick-low" class="text-blue-400">--</span></span>
                <span class="info-label text-slate-400">C: <span id="tick-close" class="text-blue-400">--</span></span>
                <span class="info-label text-slate-400">Vol: <span id="tick-vol" class="text-yellow-400">--</span></span>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <!-- 回测按钮 -->
            <button onclick="runBacktest()" class="px-3 py-1 bg-indigo-600 hover:bg-indigo-500 text-white text-xs rounded transition font-bold border border-indigo-500 shadow-lg shadow-indigo-900/50">
                <i class="fa-solid fa-flask me-1"></i> 回测策略
            </button>

            <div class="flex items-center gap-2 bg-slate-800 px-2 py-1 rounded border border-slate-700 theme-status-box transition-colors duration-300">
                <div class="w-2 h-2 rounded-full bg-slate-500" id="live-indicator"></div>
                <label class="text-xs cursor-pointer select-none flex items-center gap-2">
                    <input type="checkbox" id="autoRefresh" class="hidden" onchange="toggleAutoRefresh()">
                    <span id="autoRefreshText">Live Off</span>
                </label>
            </div>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        <aside id="main-sidebar" class="w-64 glass-sidebar border-r border-slate-800 flex flex-col p-4 gap-5 overflow-y-auto z-10 transition-colors duration-300">
            <!-- Timeframe -->
            <div class="space-y-2">
                <div class="section-title text-xs font-bold text-slate-500 uppercase tracking-widest mb-2">Timeframe</div>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="setPeriod('5s')" class="period-btn px-3 py-1.5 rounded text-xs font-medium transition-all duration-200 border border-slate-700 hover:bg-slate-800 text-slate-400 active-period bg-blue-600 border-blue-500 text-white" data-val="5s">5s</button>
                    <button onclick="setPeriod('10s')" class="period-btn px-3 py-1.5 rounded text-xs font-medium transition-all duration-200 border border-slate-700 hover:bg-slate-800 text-slate-400" data-val="10s">10s</button>
                    <button onclick="setPeriod('30s')" class="period-btn px-3 py-1.5 rounded text-xs font-medium transition-all duration-200 border border-slate-700 hover:bg-slate-800 text-slate-400" data-val="30s">30s</button>
                    <button onclick="setPeriod('1min')" class="period-btn px-3 py-1.5 rounded text-xs font-medium transition-all duration-200 border border-slate-700 hover:bg-slate-800 text-slate-400" data-val="1min">1m</button>
                </div>
                <div class="relative mt-1">
                    <input type="text" id="customPeriodInput" placeholder="Custom (e.g. 15s)" class="theme-input w-full bg-slate-900 border border-slate-700 rounded px-3 py-1.5 text-xs focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition text-slate-300 placeholder-slate-600">
                    <button onclick="applyCustomPeriod()" class="theme-input-btn absolute right-1 top-1 bottom-1 px-2 text-[10px] bg-slate-800 hover:bg-slate-700 rounded text-slate-300 transition">GO</button>
                </div>
            </div>

            <hr class="theme-divider border-slate-800">

            <div class="space-y-3">
                <div class="section-title text-xs font-bold text-slate-500 uppercase tracking-widest">Main Indicators</div>
                <div class="flex items-center justify-between group">
                    <label class="flex items-center gap-2 cursor-pointer text-sm text-slate-300 hover:text-white transition theme-text-main">
                        <input type="checkbox" id="showMA" checked onchange="updateChartVisibility()" class="rounded border-slate-600 bg-slate-800 text-blue-500 focus:ring-0 w-3.5 h-3.5 theme-checkbox">
                        <span>MA <span class="text-xs text-slate-500 theme-text-sub">(SMA)</span></span>
                    </label>
                    <input type="number" id="maPeriod" value="10" class="theme-input-line w-12 bg-transparent border-b border-slate-700 text-right text-xs focus:border-blue-500 outline-none text-yellow-500 font-mono" onchange="fetchData()">
                </div>
                <div class="flex items-center justify-between group">
                    <label class="flex items-center gap-2 cursor-pointer text-sm text-slate-300 hover:text-white transition theme-text-main">
                        <input type="checkbox" id="showEMA" checked onchange="updateChartVisibility()" class="rounded border-slate-600 bg-slate-800 text-cyan-500 focus:ring-0 w-3.5 h-3.5 theme-checkbox">
                        <span>EMA</span>
                    </label>
                    <input type="number" id="emaPeriod" value="20" class="theme-input-line w-12 bg-transparent border-b border-slate-700 text-right text-xs focus:border-cyan-500 outline-none text-cyan-400 font-mono" onchange="fetchData()">
                </div>
                <div class="flex items-center justify-between group">
                    <label class="flex items-center gap-2 cursor-pointer text-sm text-slate-300 hover:text-white transition theme-text-main">
                        <input type="checkbox" id="showBOLL" onchange="updateChartVisibility()" class="rounded border-slate-600 bg-slate-800 text-purple-500 focus:ring-0 w-3.5 h-3.5 theme-checkbox">
                        <span>BOLL</span>
                    </label>
                    <div class="flex gap-1 items-center">
                        <input type="number" id="bollPeriod" value="20" class="theme-input-line w-10 bg-transparent border-b border-slate-700 text-center text-xs focus:border-purple-500 outline-none text-purple-400 font-mono" onchange="fetchData()">
                        <span class="text-[10px] text-slate-600 font-mono theme-text-sub">/</span>
                        <input type="number" id="bollStd" value="2" step="0.5" class="theme-input-line w-10 bg-transparent border-b border-slate-700 text-center text-xs focus:border-purple-500 outline-none text-purple-400 font-mono" onchange="fetchData()">
                    </div>
                </div>
            </div>

            <hr class="theme-divider border-slate-800">

            <div class="space-y-3">
                <div class="section-title text-xs font-bold text-slate-500 uppercase tracking-widest">Sub Indicator</div>
                <div class="flex flex-col gap-1">
                    <button onclick="setSubIndicator('vol')" class="sub-ind-btn text-left px-3 py-2 rounded text-xs transition border border-transparent hover:bg-slate-800 text-slate-300 bg-slate-800/50 border-slate-700 text-blue-400 font-bold" data-val="vol">
                        <i class="fa-solid fa-chart-bar w-4"></i> Volume
                    </button>
                    <button onclick="setSubIndicator('macd')" class="sub-ind-btn text-left px-3 py-2 rounded text-xs transition border border-transparent hover:bg-slate-800 text-slate-400" data-val="macd">
                        <i class="fa-solid fa-wave-square w-4"></i> MACD
                    </button>
                    <button onclick="setSubIndicator('rsi')" class="sub-ind-btn text-left px-3 py-2 rounded text-xs transition border border-transparent hover:bg-slate-800 text-slate-400" data-val="rsi">
                        <i class="fa-solid fa-bolt w-4"></i> RSI
                    </button>
                </div>
            </div>

            <!-- Bottom -->
            <div class="mt-auto relative">
                <div id="settingsPanel" class="hidden absolute bottom-12 left-0 w-full bg-slate-800 border border-slate-700 rounded p-3 space-y-3 fade-in shadow-xl z-30 theme-panel">
                    <div class="section-title text-xs font-bold text-slate-500 uppercase tracking-widest mb-1">Theme</div>
                    <div class="flex items-center justify-between theme-text-main">
                        <span class="text-sm">Light/Dark Mode</span>
                        <button onclick="toggleTheme()" id="themeToggle" class="px-2 py-0.5 rounded text-xs transition-colors duration-200 font-mono bg-blue-600 text-white border border-blue-600">Dark</button>
                    </div>
                    <div class="section-title text-xs font-bold text-slate-500 uppercase tracking-widest pt-2 mb-1 border-t border-slate-700 theme-divider">Visuals</div>
                    <div class="space-y-2">
                        <!-- Bid/Ask Lines -->
                        <div class="flex items-center justify-between theme-text-main">
                            <label class="flex items-center gap-2 cursor-pointer text-sm">
                                <input type="checkbox" id="showBidAsk" onchange="toggleBidAskLines()" class="rounded border-slate-600 bg-slate-900 text-blue-500 focus:ring-0 w-3.5 h-3.5 theme-checkbox">
                                <span>Bid/Ask 20p Lines</span>
                            </label>
                        </div>
                        <!-- Trade Lines (新增) -->
                        <div class="flex items-center justify-between theme-text-main">
                            <label class="flex items-center gap-2 cursor-pointer text-sm">
                                <input type="checkbox" id="showTradeLines" onchange="updateChartVisibility()" checked class="rounded border-slate-600 bg-slate-900 text-blue-500 focus:ring-0 w-3.5 h-3.5 theme-checkbox">
                                <span>Show Trade Lines</span>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="flex gap-2">
                    <button onclick="fetchData()" class="action-btn flex-1 bg-slate-800 hover:bg-slate-700 text-slate-300 py-2 rounded border border-slate-700 transition flex items-center justify-center gap-2 text-xs font-bold">
                        <i class="fa-solid fa-rotate"></i> Refresh
                    </button>
                    <button onclick="toggleSettingsPanel()" id="settingsButton" class="action-btn w-10 bg-slate-800 hover:bg-slate-700 text-slate-300 py-2 rounded border border-slate-700 transition flex items-center justify-center text-xs font-bold">
                        <i class="fa-solid fa-gear"></i>
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main Chart -->
        <main id="chart-container" class="flex-1 bg-slate-950 relative flex flex-col transition-colors duration-300">
            <div id="main-chart" class="w-full h-full"></div>

            <!-- 回测结果模态框 -->
            <div id="backtestModal" class="hidden absolute inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm fade-in">
                <div class="bg-slate-900 border border-slate-700 rounded-lg shadow-2xl w-3/4 max-w-3xl max-h-[85%] flex flex-col">
                    <div class="flex justify-between items-center p-4 border-b border-slate-700 bg-slate-800 rounded-t-lg">
                        <h3 class="text-lg font-bold text-white flex items-center gap-2"><i class="fa-solid fa-flask text-indigo-500"></i> 回测报告 (Backtest Report)</h3>
                        <button onclick="closeBacktestModal()" class="text-slate-400 hover:text-white transition"><i class="fa-solid fa-times text-lg"></i></button>
                    </div>

                    <div class="p-4 grid grid-cols-3 gap-4 border-b border-slate-700 bg-slate-800/50">
                        <div class="bg-slate-800 p-3 rounded text-center border border-slate-700">
                            <div class="text-xs text-slate-500 uppercase tracking-wider font-bold">总交易数</div>
                            <div id="bt-total" class="text-xl font-bold text-white mt-1">--</div>
                        </div>
                        <div class="bg-slate-800 p-3 rounded text-center border border-slate-700">
                            <div class="text-xs text-slate-500 uppercase tracking-wider font-bold">胜率</div>
                            <div id="bt-winrate" class="text-xl font-bold text-blue-400 mt-1">--%</div>
                        </div>
                        <div class="bg-slate-800 p-3 rounded text-center border border-slate-700">
                            <div class="text-xs text-slate-500 uppercase tracking-wider font-bold">总盈亏</div>
                            <div id="bt-pnl" class="text-xl font-bold text-green-400 mt-1">--</div>
                        </div>
                    </div>

                    <div class="flex-1 overflow-y-auto p-0">
                        <table class="w-full trade-table text-left border-collapse">
                            <thead class="bg-slate-800 sticky top-0 z-10 shadow-sm">
                                <tr>
                                    <th>方向</th>
                                    <th>策略类型</th>
                                    <th>开仓</th>
                                    <th>平仓</th>
                                    <th>盈亏</th>
                                    <th>平仓原因</th>
                                </tr>
                            </thead>
                            <tbody id="bt-list" class="divide-y divide-slate-700/50 text-slate-300">
                                <!-- JS填充 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        let myChart = echarts.init(document.getElementById('main-chart'));
        let currentPeriod = '5s';
        let currentSubInd = 'vol';
        let autoRefreshInterval = null;
        let globalData = null;
        let globalBacktestReport = null;
        let tradeMarkLineData = []; // 存储交易连线数据
        let showBidAskLines = false;
        const BID_ASK_SPREAD = 0.20;
        let zoomState = { start: 80, end: 100 };
        let isDarkMode = true;
        let rafId = null;
        let lastMouseEvent = null;

        window.addEventListener('resize', () => myChart.resize());

        // Zoom Memory
        myChart.on('datazoom', function(evt) {
            const opt = myChart.getOption();
            if(opt.dataZoom && opt.dataZoom.length > 0) {
                zoomState.start = opt.dataZoom[0].start;
                zoomState.end = opt.dataZoom[0].end;
            }
        });

        // Mouse Move Performance Optimized (Updated to support trade lines)
        myChart.getDom().addEventListener('mousemove', function(e) {
            if (!showBidAskLines || !globalData) return;
            lastMouseEvent = e;
            if (rafId) return;
            rafId = requestAnimationFrame(() => {
                handleMouseMove(lastMouseEvent);
                rafId = null;
            });
        });

        function handleMouseMove(e) {
            if (!showBidAskLines) return;
            const rect = myChart.getDom().getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            let price = null;
            try {
                const point = myChart.convertFromPixel({ seriesIndex: 0 }, [x, y]);
                if (point) price = point[1];
            } catch (err) {}

            if (price === null || isNaN(price)) return;

            const halfSpread = BID_ASK_SPREAD / 2;
            const askPrice = price + halfSpread;
            const bidPrice = price - halfSpread;

            const lineColor = isDarkMode ? '#60a5fa' : '#2563eb';
            const textColor = isDarkMode ? '#e2e8f0' : '#1e293b';
            const bgColor = isDarkMode ? 'rgba(15, 23, 42, 0.8)' : 'rgba(255, 255, 255, 0.9)';

            // 合并静态交易线和动态鼠标线
            const dynamicLines = [
                { yAxis: askPrice, name: 'Ask' },
                { yAxis: bidPrice, name: 'Bid' }
            ];

            // 如果交易线开启，则合并
            const combinedData = tradeMarkLineData.length > 0 ? [...tradeMarkLineData, ...dynamicLines] : dynamicLines;

            myChart.setOption({
                series: [{
                    id: 'Price',
                    markLine: {
                        silent: true,
                        symbol: 'none',
                        animation: false,
                        lineStyle: { type: 'solid', color: lineColor, width: 1, opacity: 0.8 },
                        label: {
                            show: true,
                            position: 'end',
                            formatter: (params) => {
                                // 区分是否是 Ask/Bid 线
                                if(params.name === 'Ask' || params.name === 'Bid') {
                                    return `${params.name}: ${params.value.toFixed(2)}`;
                                }
                                return ''; // 交易连线不显示标签
                            },
                            color: textColor,
                            backgroundColor: bgColor,
                            padding: [2, 4],
                            borderRadius: 2,
                            fontSize: 10
                        },
                        data: combinedData
                    }
                }]
            });
        }

        myChart.getDom().addEventListener('mouseout', function() {
            if (showBidAskLines) {
                // 恢复为仅显示交易连线（如果有）
                myChart.setOption({
                    series: [{
                        id: 'Price',
                        markLine: { data: tradeMarkLineData }
                    }]
                });
            }
        });

        document.addEventListener('keydown', function(e) {
            if (e.target.tagName === 'INPUT') return;
            if (!globalData || !globalData.categoryData) return;
            let direction = 0;
            if (e.key === 'ArrowRight') direction = 1;
            if (e.key === 'ArrowLeft') direction = -1;
            if (direction === 0) return;

            const totalBars = globalData.categoryData.length;
            if (totalBars === 0) return;
            const step = (100 / totalBars) * direction * 3;
            let newStart = zoomState.start + step;
            let newEnd = zoomState.end + step;
            const range = zoomState.end - zoomState.start;
            if (newEnd > 100) { newEnd = 100; newStart = 100 - range; }
            else if (newStart < 0) { newStart = 0; newEnd = range; }

            myChart.dispatchAction({ type: 'dataZoom', dataZoomIndex: [0, 1], start: newStart, end: newEnd });
        });

        // --- Backtest Logic ---
        function runBacktest() {
            const maP = document.getElementById('maPeriod').value;
            const emaP = document.getElementById('emaPeriod').value;
            const bollP = document.getElementById('bollPeriod').value;
            const bollS = document.getElementById('bollStd').value;

            const btn = document.querySelector('button[onclick="runBacktest()"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> 计算中...';
            btn.disabled = true;

            fetch(`/api/run_backtest?period=${currentPeriod}&ma=${maP}&ema=${emaP}&bollP=${bollP}&bollS=${bollS}`)
                .then(res => res.json())
                .then(data => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;

                    if(data.status === 'success') {
                        globalBacktestReport = data.report;
                        renderChart(globalData); // 刷新图表显示标记和连线
                        showBacktestResults(data.report);
                    } else {
                        alert("回测失败: " + data.message);
                    }
                })
                .catch(err => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    console.error(err);
                    alert("网络错误");
                });
        }

        function showBacktestResults(report) {
            document.getElementById('bt-total').innerText = report.total_trades;
            document.getElementById('bt-winrate').innerText = report.win_rate + '%';
            document.getElementById('bt-pnl').innerText = report.total_pnl;
            document.getElementById('bt-pnl').className = report.total_pnl >= 0 ? "text-xl font-bold text-green-400 mt-1" : "text-xl font-bold text-red-400 mt-1";

            const list = document.getElementById('bt-list');
            list.innerHTML = '';

            const typeMap = { 'Long': '做多 (Long)', 'Short': '做空 (Short)' };
            const strategyMap = { 'trend': '趋势跟随', 'oscillation': '震荡回归' };
            const reasonMap = { 'Time Stop (MA Return)': '超时平仓', 'Oscillation Profit': '震荡止盈', 'Trend Target': '趋势止盈' };

            report.trades.forEach(t => {
                const pnlColor = t.pnl >= 0 ? 'text-green-400' : 'text-red-400';
                const typeColor = t.type === 'Long' ? 'text-blue-400' : 'text-orange-400';
                const row = `
                    <tr class="hover:bg-slate-700/50 transition border-b border-slate-700/50 last:border-0">
                        <td class="${typeColor} font-bold">${typeMap[t.type] || t.type}</td>
                        <td class="text-slate-300">${strategyMap[t.strategy] || t.strategy}</td>
                        <td><div class="font-mono">${t.entry_price}</div><div class="text-[10px] text-slate-500">${t.entry_time.split(' ')[1]}</div></td>
                        <td><div class="font-mono">${t.exit_price}</div><div class="text-[10px] text-slate-500">${t.exit_time.split(' ')[1]}</div></td>
                        <td class="${pnlColor} font-bold font-mono">${t.pnl > 0 ? '+' : ''}${t.pnl}</td>
                        <td class="text-slate-400 text-xs">${reasonMap[t.reason] || t.reason}</td>
                    </tr>`;
                list.innerHTML += row;
            });
            document.getElementById('backtestModal').classList.remove('hidden');
        }

        function closeBacktestModal() { document.getElementById('backtestModal').classList.add('hidden'); }

        // --- Theme & Others ---
        function toggleSettingsPanel() { document.getElementById('settingsPanel').classList.toggle('hidden'); }

        function toggleTheme() {
            isDarkMode = !isDarkMode;
            const btn = document.getElementById('themeToggle');
            const body = document.body;
            const header = document.getElementById('main-header');
            const sidebar = document.getElementById('main-sidebar');
            const chartContainer = document.getElementById('chart-container');
            const appTitle = document.getElementById('app-title');

            if (isDarkMode) {
                body.className = "bg-slate-950 text-slate-300 font-sans h-screen flex flex-col overflow-hidden selection:bg-blue-500 selection:text-white transition-colors duration-300";
                header.className = "bg-slate-900 border-b border-slate-800 h-12 flex items-center px-4 justify-between flex-shrink-0 z-20 shadow-md transition-colors duration-300";
                sidebar.className = "w-64 glass-sidebar border-r border-slate-800 flex flex-col p-4 gap-5 overflow-y-auto z-10 transition-colors duration-300";
                chartContainer.className = "flex-1 bg-slate-950 relative flex flex-col transition-colors duration-300";
                appTitle.className = "font-bold text-slate-100 tracking-wider";
                btn.innerText = "Dark";
                btn.className = "px-2 py-0.5 rounded text-xs transition-colors duration-200 font-mono bg-blue-600 text-white border border-blue-600";
                updateThemeClasses(true);
            } else {
                body.className = "bg-slate-50 text-slate-800 font-sans h-screen flex flex-col overflow-hidden selection:bg-blue-200 selection:text-slate-900 transition-colors duration-300";
                header.className = "bg-white border-b border-slate-200 h-12 flex items-center px-4 justify-between flex-shrink-0 z-20 shadow-sm transition-colors duration-300";
                sidebar.className = "w-64 bg-white border-r border-slate-200 flex flex-col p-4 gap-5 overflow-y-auto z-10 transition-colors duration-300";
                chartContainer.className = "flex-1 bg-white relative flex flex-col transition-colors duration-300";
                appTitle.className = "font-bold text-slate-800 tracking-wider";
                btn.innerText = "Light";
                btn.className = "px-2 py-0.5 rounded text-xs transition-colors duration-200 font-mono bg-slate-200 text-slate-600 border border-slate-300";
                updateThemeClasses(false);
            }
            if(globalData) renderChart(globalData);
        }

        function updateThemeClasses(dark) {
            document.querySelectorAll('.info-label').forEach(el => el.className = dark ? "info-label text-slate-400" : "info-label text-slate-500");
            document.querySelectorAll('.section-title').forEach(el => el.className = dark ? "section-title text-xs font-bold text-slate-500 uppercase tracking-widest mb-2" : "section-title text-xs font-bold text-slate-400 uppercase tracking-widest mb-2");
            document.querySelectorAll('.theme-text-main').forEach(el => el.className = dark ? "flex items-center gap-2 cursor-pointer text-sm text-slate-300 hover:text-white transition theme-text-main" : "flex items-center gap-2 cursor-pointer text-sm text-slate-700 hover:text-blue-600 transition theme-text-main");
            document.querySelectorAll('.theme-text-sub').forEach(el => el.className = dark ? "text-xs text-slate-500 theme-text-sub" : "text-xs text-slate-400 theme-text-sub");

            document.querySelectorAll('.period-btn').forEach(btn => {
                const isActive = btn.classList.contains('active-period');
                if(!isActive) {
                    btn.className = dark
                        ? "period-btn px-3 py-1.5 rounded text-xs font-medium transition-all duration-200 border border-slate-700 hover:bg-slate-800 text-slate-400"
                        : "period-btn px-3 py-1.5 rounded text-xs font-medium transition-all duration-200 border border-slate-200 hover:bg-slate-100 text-slate-600";
                } else {
                     btn.className = dark
                        ? "period-btn px-3 py-1.5 rounded text-xs font-medium transition-all duration-200 border border-slate-700 hover:bg-slate-800 active-period bg-blue-600 border-blue-500 text-white shadow-lg shadow-blue-900/50"
                        : "period-btn px-3 py-1.5 rounded text-xs font-medium transition-all duration-200 border border-slate-200 hover:bg-slate-100 active-period bg-blue-500 border-blue-400 text-white shadow-md shadow-blue-200";
                }
            });

            document.getElementById('customPeriodInput').className = dark ? "theme-input w-full bg-slate-900 border border-slate-700 rounded px-3 py-1.5 text-xs focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition text-slate-300 placeholder-slate-600" : "theme-input w-full bg-slate-50 border border-slate-300 rounded px-3 py-1.5 text-xs focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition text-slate-800 placeholder-slate-400";
            document.querySelector('.theme-input-btn').className = dark ? "theme-input-btn absolute right-1 top-1 bottom-1 px-2 text-[10px] bg-slate-800 hover:bg-slate-700 rounded text-slate-300 transition" : "theme-input-btn absolute right-1 top-1 bottom-1 px-2 text-[10px] bg-slate-200 hover:bg-slate-300 rounded text-slate-600 transition";

            document.querySelectorAll('.theme-divider').forEach(el => {
                if(el.tagName === 'HR') el.className = dark ? "theme-divider border-slate-800" : "theme-divider border-slate-200";
                else if(el.tagName === 'DIV') el.className = dark ? "section-title text-xs font-bold text-slate-500 uppercase tracking-widest pt-2 mb-1 border-t border-slate-700 theme-divider" : "section-title text-xs font-bold text-slate-400 uppercase tracking-widest pt-2 mb-1 border-t border-slate-200 theme-divider";
            });

            document.querySelectorAll('.action-btn').forEach(btn => {
                let base = dark
                    ? "action-btn bg-slate-800 hover:bg-slate-700 text-slate-300 py-2 rounded border border-slate-700 transition flex items-center justify-center gap-2 text-xs font-bold"
                    : "action-btn bg-white hover:bg-slate-50 text-slate-700 py-2 rounded border border-slate-200 transition flex items-center justify-center gap-2 text-xs font-bold";
                if(btn.id === 'settingsButton') btn.className = base + " w-10";
                else btn.className = base + " flex-1";
            });

            document.querySelector('.theme-status-box').className = dark ? "flex items-center gap-2 bg-slate-800 px-2 py-1 rounded border border-slate-700 theme-status-box transition-colors duration-300" : "flex items-center gap-2 bg-white px-2 py-1 rounded border border-slate-200 theme-status-box transition-colors duration-300";
            document.getElementById('settingsPanel').className = dark ? "hidden absolute bottom-12 left-0 w-full bg-slate-800 border border-slate-700 rounded p-3 space-y-3 fade-in shadow-xl z-30 theme-panel" : "hidden absolute bottom-12 left-0 w-full bg-white border border-slate-200 rounded p-3 space-y-3 fade-in shadow-xl z-30 theme-panel";
            updateSubIndStyle(currentSubInd);
        }

        function updateSubIndStyle(val) {
            document.querySelectorAll('.sub-ind-btn').forEach(btn => {
                const isActive = btn.dataset.val === val;
                if(isDarkMode) {
                    btn.className = isActive
                        ? "sub-ind-btn text-left px-3 py-2 rounded text-xs transition border border-transparent hover:bg-slate-800 text-slate-300 bg-slate-800/50 border-slate-700 text-blue-400 font-bold"
                        : "sub-ind-btn text-left px-3 py-2 rounded text-xs transition border border-transparent hover:bg-slate-800 text-slate-400";
                } else {
                     btn.className = isActive
                        ? "sub-ind-btn text-left px-3 py-2 rounded text-xs transition border border-transparent hover:bg-slate-100 text-slate-800 bg-blue-50 border-blue-200 text-blue-600 font-bold"
                        : "sub-ind-btn text-left px-3 py-2 rounded text-xs transition border border-transparent hover:bg-slate-50 text-slate-500";
                }
            });
        }

        function toggleBidAskLines() {
            showBidAskLines = document.getElementById('showBidAsk').checked;
            if (!showBidAskLines) {
                // 关闭 Bid/Ask 时，如果有交易连线，恢复显示交易连线
                myChart.setOption({ series: [{ id: 'Price', markLine: { data: tradeMarkLineData } }] });
            }
        }

        function setPeriod(val) {
            currentPeriod = val;
            zoomState = { start: 80, end: 100 };
            document.querySelectorAll('.period-btn').forEach(btn => {
                if(btn.dataset.val === val) btn.classList.add('active-period');
                else btn.classList.remove('active-period');
            });
            updateThemeClasses(isDarkMode);
            fetchData();
        }

        function applyCustomPeriod() {
            const val = document.getElementById('customPeriodInput').value;
            if(val) {
                zoomState = { start: 80, end: 100 };
                document.querySelectorAll('.period-btn').forEach(btn => btn.classList.remove('active-period'));
                updateThemeClasses(isDarkMode);
                currentPeriod = val;
                fetchData();
            }
        }

        function setSubIndicator(val) {
            currentSubInd = val;
            updateSubIndStyle(val);
            if(globalData) renderChart(globalData);
        }

        function toggleAutoRefresh() {
            const checkbox = document.getElementById('autoRefresh');
            const indicator = document.getElementById('live-indicator');
            const text = document.getElementById('autoRefreshText');
            if(checkbox.checked) {
                indicator.classList.remove('bg-slate-500');
                indicator.classList.add('bg-green-500', 'animate-pulse');
                text.innerText = "Live On";
                text.classList.add('text-green-500');
                fetchData();
                autoRefreshInterval = setInterval(fetchData, 2000);
            } else {
                indicator.classList.remove('bg-green-500', 'animate-pulse');
                indicator.classList.add('bg-slate-500');
                text.innerText = "Live Off";
                text.classList.remove('text-green-500');
                clearInterval(autoRefreshInterval);
            }
        }

        function updateChartVisibility() { if(globalData) renderChart(globalData); }

        function fetchData() {
            // 清除旧的回测标记
            globalBacktestReport = null;
            tradeMarkLineData = [];

            const maP = document.getElementById('maPeriod').value;
            const emaP = document.getElementById('emaPeriod').value;
            const bollP = document.getElementById('bollPeriod').value;
            const bollS = document.getElementById('bollStd').value;

            if(!autoRefreshInterval) {
                const textColor = isDarkMode ? '#94a3b8' : '#334155';
                const maskColor = isDarkMode ? 'rgba(15, 23, 42, 0.4)' : 'rgba(255, 255, 255, 0.4)';
                myChart.showLoading({ color: '#3b82f6', textColor: textColor, maskColor: maskColor });
            }

            fetch(`/api/kline?period=${currentPeriod}&ma=${maP}&ema=${emaP}&bollP=${bollP}&bollS=${bollS}`)
                .then(res => res.json())
                .then(data => {
                    myChart.hideLoading();
                    if(data.status === 'success') {
                        globalData = data;
                        try {
                            renderChart(data);
                        } catch (renderError) {
                            console.error("Render Error:", renderError);
                            alert("图表渲染失败，请查看控制台。");
                        }
                    } else {
                        console.error(data.message);
                    }
                })
                .catch(err => {
                    myChart.hideLoading();
                    console.error("Fetch Error:", err);
                });
        }

        function renderChart(data) {
            const showMA = document.getElementById('showMA').checked;
            const showEMA = document.getElementById('showEMA').checked;
            const showBOLL = document.getElementById('showBOLL').checked;
            const showTradeLines = document.getElementById('showTradeLines').checked; // 获取开关状态
            const maP = document.getElementById('maPeriod').value;
            const emaP = document.getElementById('emaPeriod').value;
            const bollP = document.getElementById('bollPeriod').value;
            const bollS = document.getElementById('bollStd').value;

            const upColor = '#22c55e';
            const downColor = '#ef4444';
            const maColor = '#eab308';
            const emaColor = '#06b6d4';
            const bollColor = '#a855f7';

            const bgColor = isDarkMode ? '#020617' : '#ffffff';
            const gridLineColor = isDarkMode ? '#1e293b' : '#f1f5f9';
            const axisLabelColor = isDarkMode ? '#64748b' : '#94a3b8';
            const tooltipBg = isDarkMode ? 'rgba(15, 23, 42, 0.95)' : 'rgba(255, 255, 255, 0.95)';
            const tooltipBorder = isDarkMode ? '#334155' : '#e2e8f0';
            const tooltipText = isDarkMode ? '#e2e8f0' : '#1e293b';

            const ohlcData = data.values.map(item => [item[0], item[1], item[2], item[3]]);

            // --- 构建回测标记数据 & 连线数据 ---
            let markPointData = [];
            tradeMarkLineData = []; // 重置全局连线数据

            if (globalBacktestReport && globalBacktestReport.trades) {
                globalBacktestReport.trades.forEach(trade => {
                    const isWin = trade.pnl >= 0;
                    const lineColor = isWin ? '#22c55e' : '#ef4444'; // 赢绿输红

                    // 1. Entry Marker
                    markPointData.push({
                        name: 'Entry',
                        coord: [trade.entry_time, trade.entry_price],
                        symbol: 'arrow',
                        symbolRotate: trade.type === 'Long' ? 0 : 180,
                        symbolSize: 10,
                        symbolOffset: [0, trade.type === 'Long' ? 10 : -10],
                        itemStyle: { color: trade.type === 'Long' ? '#3b82f6' : '#f97316' },
                        label: { show: false }
                    });

                    // 2. Exit Marker
                    markPointData.push({
                        name: 'Exit',
                        coord: [trade.exit_time, trade.exit_price],
                        symbol: 'circle',
                        symbolSize: 6,
                        itemStyle: { color: lineColor },
                        label: { show: false }
                    });

                    // 3. Trade Connection Line (MarkLine)
                    if (showTradeLines) {
                        tradeMarkLineData.push([
                            { coord: [trade.entry_time, trade.entry_price], lineStyle: { type: 'dashed', color: lineColor, width: 1, opacity: 0.6 } },
                            { coord: [trade.exit_time, trade.exit_price] }
                        ]);
                    }
                });
            }

            let seriesList = [
                {
                    id: 'Price',
                    name: 'Price',
                    type: 'candlestick',
                    data: ohlcData,
                    itemStyle: { color: upColor, color0: downColor, borderColor: upColor, borderColor0: downColor },
                    z: 10,
                    // 初始加载 tradeMarkLineData
                    markLine: {
                        symbol: 'none',
                        data: tradeMarkLineData,
                        silent: true // 静态线不需要交互
                    },
                    markPoint: {
                        symbolSize: 10,
                        label: { show: false },
                        data: markPointData,
                        tooltip: {
                            formatter: function(param) {
                                return `${param.name}<br>${param.data.coord[1].toFixed(2)}`;
                            }
                        }
                    }
                }
            ];

            if(showMA) seriesList.push({ name: `MA${maP}`, type: 'line', data: data.maData, smooth: true, showSymbol: false, lineStyle: { width: 1, color: maColor } });
            if(showEMA) seriesList.push({ name: `EMA${emaP}`, type: 'line', data: data.emaData, smooth: true, showSymbol: false, lineStyle: { width: 1, color: emaColor } });
            if(showBOLL) seriesList.push(
                { name: `BOLL UP (${bollP}, ${bollS})`, type: 'line', data: data.boll.up, smooth: true, showSymbol: false, lineStyle: { width: 1, opacity: 0.5, color: bollColor } },
                { name: `BOLL LOW (${bollP}, ${bollS})`, type: 'line', data: data.boll.low, smooth: true, showSymbol: false, lineStyle: { width: 1, opacity: 0.5, color: bollColor } }
            );

            let gridConfig = [{ left: '50', right: '20', top: '20', height: '60%' }, { left: '50', right: '20', top: '75%', height: '15%' }];
            let xAxisConfig = [
                { type: 'category', data: data.categoryData, gridIndex: 0, axisLabel: { show: false }, axisTick: { show: false }, boundaryGap: false },
                { type: 'category', data: data.categoryData, gridIndex: 1, axisLabel: { color: axisLabelColor, fontSize: 10 }, boundaryGap: false }
            ];

            if(currentSubInd === 'vol') {
                seriesList.push({
                    name: 'Volume',
                    type: 'bar',
                    xAxisIndex: 1,
                    yAxisIndex: 1,
                    data: data.values.map((item) => {
                        const [open, close, , , volume] = item;
                        return { value: volume, itemStyle: { color: close >= open ? 'rgba(34, 197, 94, 0.5)' : 'rgba(239, 68, 68, 0.5)' } }
                    })
                });
            } else if(currentSubInd === 'macd') {
                seriesList.push(
                    { name: 'DIF', type: 'line', xAxisIndex: 1, yAxisIndex: 1, data: data.macd.dif, showSymbol: false, lineStyle: { width: 1, color: isDarkMode ? '#fff' : '#334155' } },
                    { name: 'DEA', type: 'line', xAxisIndex: 1, yAxisIndex: 1, data: data.macd.dea, showSymbol: false, lineStyle: { width: 1, color: '#f59e0b' } },
                    { name: 'MACD', type: 'bar', xAxisIndex: 1, yAxisIndex: 1, data: data.macd.hist, itemStyle: { color: (params) => params.value > 0 ? '#22c55e' : '#ef4444' } }
                );
            } else if(currentSubInd === 'rsi') {
                seriesList.push({
                    name: 'RSI', type: 'line', xAxisIndex: 1, yAxisIndex: 1, data: data.rsi, showSymbol: false, lineStyle: { width: 1, color: '#d946ef' },
                    markLine: { symbol: 'none', data: [{ yAxis: 70 }, { yAxis: 30 }], lineStyle: { type: 'dashed', color: isDarkMode ? '#475569' : '#cbd5e1', width: 0.5 } }
                });
            }

            const option = {
                backgroundColor: bgColor,
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'cross', label: { backgroundColor: isDarkMode ? '#334155' : '#94a3b8' } },
                    backgroundColor: tooltipBg,
                    borderColor: tooltipBorder,
                    textStyle: { color: tooltipText, fontSize: 12 },
                    formatter: function (params) {
                        if (params.length > 0) {
                            const timeIndex = data.categoryData.indexOf(params[0].axisValue);
                            if (timeIndex !== -1 && globalData.values[timeIndex]) {
                                const [o, c, l, h, vol] = globalData.values[timeIndex];
                                document.getElementById('tick-open').innerText = o.toFixed(2);
                                document.getElementById('tick-high').innerText = h.toFixed(2);
                                document.getElementById('tick-low').innerText = l.toFixed(2);
                                const closeEl = document.getElementById('tick-close');
                                closeEl.innerText = c.toFixed(2);
                                closeEl.className = c >= o ? 'text-green-500 font-bold' : 'text-red-500 font-bold';
                                document.getElementById('tick-vol').innerText = vol;
                            } else {
                                ['tick-open', 'tick-high', 'tick-low', 'tick-close', 'tick-vol'].forEach(id => document.getElementById(id).innerText = '--');
                            }

                            let html = `<div class="font-mono text-xs font-bold mb-1 border-b pb-1 ${isDarkMode?'border-slate-700':'border-slate-200'}">${params[0].axisValue}</div>`;
                            if (timeIndex !== -1 && globalData.values[timeIndex]) {
                                const [o, c, l, h, v] = globalData.values[timeIndex];
                                const labelColor = isDarkMode ? 'text-slate-400' : 'text-slate-500';
                                html += `<div class="flex justify-between gap-4 text-xs"><span class="${labelColor}">O/H/L/C</span><span class="${c >= o ? 'text-green-500' : 'text-red-500'}">${o.toFixed(2)}/${h.toFixed(2)}/${l.toFixed(2)}/${c.toFixed(2)}</span></div>`;
                                html += `<div class="flex justify-between gap-4 text-xs"><span class="${labelColor}">Volume</span><span class="text-yellow-500 font-bold">${v}</span></div>`;
                            }

                            params.forEach(item => {
                                if(item.seriesType !== 'candlestick' && item.seriesName !== 'Volume' && item.value !== undefined && item.value !== null) {
                                    let val = typeof item.value === 'number' ? item.value.toFixed(2) : item.value;
                                    let slopeInfo = '';
                                    if (item.seriesName.startsWith('MA') && globalData.maSlope && globalData.maSlope[timeIndex] !== undefined) {
                                         const slope = globalData.maSlope[timeIndex];
                                         if (slope !== null) slopeInfo = ` <span class="text-[10px] opacity-70">(${slope > 0 ? '↗' : (slope < 0 ? '↘' : '→')} ${Math.abs(slope).toFixed(2)})</span>`;
                                    } else if (item.seriesName.startsWith('EMA') && globalData.emaSlope && globalData.emaSlope[timeIndex] !== undefined) {
                                         const slope = globalData.emaSlope[timeIndex];
                                         if (slope !== null) slopeInfo = ` <span class="text-[10px] opacity-70">(${slope > 0 ? '↗' : (slope < 0 ? '↘' : '→')} ${Math.abs(slope).toFixed(2)})</span>`;
                                    }
                                    html += `<div class="flex justify-between gap-4 text-xs"><span style="color:${item.color}">${item.seriesName}</span><span>${val}${slopeInfo}</span></div>`;
                                }
                            });
                            return html;
                        }
                    }
                },
                axisPointer: { link: { xAxisIndex: 'all' } },
                grid: gridConfig,
                xAxis: xAxisConfig,
                yAxis: [
                    { scale: true, gridIndex: 0, splitLine: { lineStyle: { color: gridLineColor } }, axisLabel: { color: axisLabelColor } },
                    { scale: true, gridIndex: 1, splitLine: { show: false }, axisLabel: { color: axisLabelColor, fontSize: 10 }, splitNumber: 3 }
                ],
                dataZoom: [
                    { type: 'inside', xAxisIndex: [0, 1], start: zoomState.start, end: zoomState.end },
                    { type: 'slider', xAxisIndex: [0, 1], top: '94%', height: 16, borderColor: gridLineColor, fillerColor: isDarkMode ? 'rgba(59, 130, 246, 0.1)' : 'rgba(59, 130, 246, 0.2)', handleStyle: { color: '#3b82f6' }, textStyle: {color: axisLabelColor}, start: zoomState.start, end: zoomState.end }
                ],
                series: seriesList
            };

            myChart.setOption(option, true);
        }

        document.addEventListener('DOMContentLoaded', fetchData);
    </script>
</body>
</html>