<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EA Log Visualizer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background-color: #0f172a; color: #cbd5e1; }
        .chart-container { width: 100%; height: 90vh; }
        /* 自定义 Select 样式 */
        .custom-select {
            background-color: #1e293b;
            color: #e2e8f0;
            border: 1px solid #334155;
            padding: 4px 24px 4px 12px;
            border-radius: 4px;
            font-size: 0.875rem;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2394a3b8' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
        }
        .custom-select:focus { outline: none; border-color: #3b82f6; }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden">

    <header class="bg-slate-900 border-b border-slate-800 h-14 flex items-center px-6 justify-between flex-shrink-0 shadow-md">
        <div class="flex items-center gap-3">
            <i class="fa-solid fa-code-branch text-blue-500"></i>
            <span class="font-bold text-slate-100 tracking-wider">EA Log Replay</span>
        </div>

        <div class="flex items-center gap-4">
            <!-- 副图指标选择器 -->
            <div class="flex items-center gap-2">
                <span class="text-xs text-slate-500 font-bold uppercase">Sub Indicator:</span>
                <select id="subIndicatorSelect" class="custom-select" onchange="renderChart()">
                    <option value="rsi" selected>RSI</option>
                    <option value="macd">MACD</option>
                </select>
            </div>

            <button onclick="fetchData()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-1.5 rounded text-sm font-bold transition">
                <i class="fa-solid fa-rotate mr-2"></i> Reload Log
            </button>
        </div>
    </header>

    <main class="flex-1 relative">
        <div id="main-chart" class="chart-container"></div>
    </main>

    <script>
        let myChart = echarts.init(document.getElementById('main-chart'));
        let currentData = null; // 全局存储当前数据

        window.addEventListener('resize', () => myChart.resize());

        function fetchData() {
            myChart.showLoading({ color: '#3b82f6', textColor: '#94a3b8', maskColor: 'rgba(15, 23, 42, 0.4)' });

            fetch('/api/kline')
                .then(res => res.json())
                .then(data => {
                    myChart.hideLoading();
                    if(data.status === 'success') {
                        currentData = data; // 保存数据到全局变量
                        renderChart();      // 渲染图表
                    } else {
                        alert(data.message);
                    }
                })
                .catch(err => {
                    myChart.hideLoading();
                    console.error(err);
                    alert("加载失败");
                });
        }

        function renderChart() {
            if (!currentData) return;

            const data = currentData;
            const subIndicatorType = document.getElementById('subIndicatorSelect').value;

            const upColor = '#22c55e';
            const downColor = '#ef4444';
            const bgColor = '#0f172a';

            // 构建 K 线数据
            const ohlcData = data.values;
            const categoryData = data.categoryData;

            // --- 基础 Series (主图) ---
            let seriesList = [
                {
                    name: 'Price',
                    type: 'candlestick',
                    data: ohlcData,
                    itemStyle: {
                        color: upColor,
                        color0: downColor,
                        borderColor: upColor,
                        borderColor0: downColor
                    },
                    markPoint: {
                        symbolSize: 12,
                        label: { show: false },
                        data: data.trades.points,
                        tooltip: {
                            formatter: function (param) {
                                return param.name + '<br>' + param.data.coord[1].toFixed(2) + '<br>' + param.data.coord[0];
                            }
                        }
                    },
                    markLine: {
                        symbol: ['none', 'none'],
                        data: data.trades.lines,
                        silent: true,
                        lineStyle: { width: 1.5 }
                    }
                },
                {
                    name: 'MA10',
                    type: 'line',
                    data: data.maData,
                    smooth: true,
                    lineStyle: { opacity: 0.5, width: 1, color: '#eab308' },
                    symbol: 'none'
                },
                {
                    name: 'Boll UP',
                    type: 'line',
                    data: data.boll.up,
                    smooth: true,
                    lineStyle: { opacity: 0.3, width: 1, type: 'dashed', color: '#a855f7' },
                    symbol: 'none'
                },
                {
                    name: 'Boll LOW',
                    type: 'line',
                    data: data.boll.low,
                    smooth: true,
                    lineStyle: { opacity: 0.3, width: 1, type: 'dashed', color: '#a855f7' },
                    symbol: 'none'
                }
            ];

            // --- 动态添加副图 Series ---
            if (subIndicatorType === 'rsi') {
                seriesList.push({
                    name: 'RSI',
                    type: 'line',
                    xAxisIndex: 1,
                    yAxisIndex: 1,
                    data: data.rsi,
                    lineStyle: { width: 1, color: '#d946ef' },
                    symbol: 'none',
                    markLine: {
                        data: [
                            { yAxis: 70, lineStyle: { color: '#ef4444', type: 'dashed' }, label: { show: false } },
                            { yAxis: 30, lineStyle: { color: '#22c55e', type: 'dashed' }, label: { show: false } }
                        ],
                        symbol: 'none'
                    }
                });
            } else if (subIndicatorType === 'macd') {
                seriesList.push(
                    {
                        name: 'DIF',
                        type: 'line',
                        xAxisIndex: 1,
                        yAxisIndex: 1,
                        data: data.macd.dif,
                        lineStyle: { width: 1, color: '#e2e8f0' }, // 白色线
                        symbol: 'none'
                    },
                    {
                        name: 'DEA',
                        type: 'line',
                        xAxisIndex: 1,
                        yAxisIndex: 1,
                        data: data.macd.dea,
                        lineStyle: { width: 1, color: '#f59e0b' }, // 黄色线
                        symbol: 'none'
                    },
                    {
                        name: 'MACD',
                        type: 'bar',
                        xAxisIndex: 1,
                        yAxisIndex: 1,
                        data: data.macd.hist,
                        itemStyle: {
                            color: function(params) {
                                return params.value >= 0 ? upColor : downColor;
                            }
                        }
                    }
                );
            }

            const option = {
                backgroundColor: bgColor,
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'cross' },
                    backgroundColor: 'rgba(15, 23, 42, 0.95)',
                    borderColor: '#334155',
                    textStyle: { color: '#e2e8f0' },
                    formatter: function (params) {
                        if (!params.length) return '';
                        let res = `<div style="margin-bottom: 5px; font-weight: bold;">${params[0].axisValue}</div>`;

                        params.forEach(item => {
                            // 过滤掉 markPoint 或 markLine 的 tooltip，只显示坐标轴触发的数据
                            if (item.componentType === 'markPoint' || item.componentType === 'markLine') return;

                            let val = item.value;
                            if (typeof val === 'number') val = val.toFixed(2);
                            if (Array.isArray(val)) val = val[1].toFixed(2); // K线取收盘价

                            if (val !== undefined && val !== null) {
                                let marker = item.marker ? item.marker : `<span style="display:inline-block;margin-right:4px;border-radius:10px;width:10px;height:10px;background-color:${item.color};"></span>`;
                                res += `<div style="display: flex; justify-content: space-between; gap: 15px;">
                                            <span>${marker} ${item.seriesName}</span>
                                            <span style="font-weight: bold;">${val}</span>
                                        </div>`;
                            }
                        });
                        return res;
                    }
                },
                grid: [
                    { left: '3%', right: '3%', top: '5%', height: '65%' },
                    { left: '3%', right: '3%', top: '75%', height: '15%' }
                ],
                xAxis: [
                    {
                        type: 'category',
                        data: categoryData,
                        scale: true,
                        boundaryGap: false,
                        axisLine: { lineStyle: { color: '#475569' } },
                        axisLabel: { color: '#94a3b8' },
                        splitLine: { show: false }
                    },
                    {
                        type: 'category',
                        gridIndex: 1,
                        data: categoryData,
                        axisLabel: { show: false },
                        boundaryGap: false
                    }
                ],
                yAxis: [
                    {
                        scale: true,
                        splitLine: { lineStyle: { color: '#1e293b' } },
                        axisLabel: { color: '#94a3b8' }
                    },
                    {
                        gridIndex: 1,
                        scale: true, // 让 MACD 自动缩放
                        splitNumber: 3,
                        axisLabel: { show: false },
                        axisTick: { show: false },
                        splitLine: { show: false }
                    }
                ],
                dataZoom: [
                    { type: 'inside', xAxisIndex: [0, 1], start: 50, end: 100 },
                    { type: 'slider', xAxisIndex: [0, 1], top: '92%', height: 20, borderColor: '#334155' }
                ],
                series: seriesList
            };

            myChart.setOption(option, true); // true 表示不合并，完全重置 series
        }

        document.addEventListener('DOMContentLoaded', fetchData);
    </script>
</body>
</html>